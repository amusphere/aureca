# 実装計画

- [ ] 1. データベーススキーマの更新
  - Userテーブルからgoogle_oauth_tokensリレーションシップを削除
  - マイグレーションファイルを作成して既存データの整合性を保つ
  - _要件: 2.1, 2.2_

- [ ] 2. Google OAuth認証サービスの拡張
- [ ] 2.1 統合認証メソッドの実装
  - create_or_update_user_with_oauth メソッドを実装
  - Google OAuth認証情報を使用してユーザーを作成または更新する機能
  - _要件: 1.1, 1.3, 3.1_

- [ ] 2.2 ユーザー認証メソッドの実装
  - authenticate_user_by_google_email メソッドを実装
  - Google emailでユーザー認証を行う機能
  - _要件: 1.2, 3.3_

- [ ] 2.3 トークンリフレッシュ機能の実装
  - refresh_token_if_needed メソッドを実装
  - validate_and_refresh_credentials メソッドを実装
  - 自動トークンリフレッシュ機能
  - _要件: 4.1, 5.2_

- [ ] 3. リポジトリ層の拡張
- [ ] 3.1 Google email検索機能の実装
  - find_user_by_google_email 関数を実装
  - Google emailでユーザーを検索する機能
  - _要件: 1.2, 3.3_

- [ ] 3.2 統合ユーザー作成機能の実装
  - create_user_with_oauth_token 関数を実装
  - ユーザーとOAuth情報を同時に作成する機能
  - トランザクション処理を含む
  - _要件: 1.1, 3.1_

- [ ] 4. APIエンドポイントの改修
- [ ] 4.1 Google OAuthコールバックの統合
  - google_oauth_callback エンドポイントを統合認証フローに更新
  - 新規ユーザー作成と既存ユーザー更新の処理
  - 適切なレスポンスモデルの実装
  - _要件: 1.1, 1.3, 3.1, 3.2_

- [ ] 4.2 認証状態チェックエンドポイントの実装
  - get_auth_status エンドポイントを実装
  - Google OAuth認証状態をチェックする機能
  - _要件: 1.2, 3.3_

- [ ] 5. レスポンスモデルの実装
- [ ] 5.1 統合認証レスポンスモデルの作成
  - GoogleAuthCompleteResponse モデルを実装
  - GoogleAuthStatusResponse モデルを実装
  - 新規ユーザーフラグの追加
  - _要件: 3.1, 3.2_

- [ ] 5.2 エラーハンドリングモデルの実装
  - GoogleOAuthError 例外クラスを実装
  - 統一されたエラーレスポンス形式
  - 適切なHTTPステータスコードの設定
  - _要件: 5.1, 5.2, 5.3_

- [ ] 6. 既存機能の互換性確保
- [ ] 6.1 既存のOAuth機能のテスト
  - トークン更新機能の動作確認
  - アクセス取り消し機能の動作確認
  - Google API呼び出し機能の動作確認
  - _要件: 4.1, 4.2, 4.3_

- [ ] 6.2 認証フローの統合テスト
  - 新規ユーザー登録フローのテスト
  - 既存ユーザーログインフローのテスト
  - エラーケースの処理テスト
  - _要件: 1.1, 1.2, 1.3, 5.1, 5.2, 5.3_

- [ ] 7. セキュリティ強化
- [ ] 7.1 トークン暗号化の確認
  - 既存の暗号化機能の動作確認
  - 新しい認証フローでの暗号化処理
  - _要件: 5.2, 5.3_

- [ ] 7.2 エラーハンドリングの強化
  - OAuth認証エラーの適切な処理
  - データベースエラーの処理
  - セキュリティエラーの処理
  - _要件: 5.1, 5.2, 5.3_

- [ ] 8. 統合とテスト
- [ ] 8.1 全体フローの統合テスト
  - 新規登録から認証完了までの全フロー
  - 既存ユーザーの認証フロー
  - トークンリフレッシュを含む長期間の動作テスト
  - _要件: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3_

- [ ] 8.2 エラーケースの包括的テスト
  - 無効な認証コードの処理
  - ネットワークエラーの処理
  - データベース接続エラーの処理
  - トークン期限切れの処理
  - _要件: 4.1, 4.2, 4.3, 5.1, 5.2, 5.3_