# 要件定義書

## 概要

現在のGoogle OAuth認証システムは、ユーザー登録とGoogle連携が分離されており、ユーザーがログイン後に再度OAuth認証を行う必要がある。この改修により、新規登録時にGoogle OAuth認証情報を直接保存し、ログイン認証もGoogle OAuth情報に基づいて行うように統合する。

## 要件

### 要件1: Google OAuth統合認証システム

**ユーザーストーリー:** 開発者として、Google OAuth認証を使用してユーザー登録とログインを統合したいので、ユーザーエクスペリエンスを向上させたい

#### 受け入れ基準

1. WHEN 新規ユーザーがGoogle OAuth認証を完了 THEN システムはユーザー情報とOAuth認証情報を同時に保存する
2. WHEN 既存ユーザーがログインを試行 THEN システムはgoogle_oauth_tokensテーブルの存在をチェックして認証を判定する
3. WHEN ユーザーがGoogle OAuth認証を完了 THEN システムはusersテーブルとgoogle_oauth_tokensテーブルに適切にデータを保存する

### 要件2: データベーススキーマの最適化

**ユーザーストーリー:** 開発者として、不要なリレーションシップを削除してデータベース構造を最適化したいので、システムの保守性を向上させたい

#### 受け入れ基準

1. WHEN データベーススキーマを更新 THEN User.google_oauth_tokensリレーションシップが削除される
2. WHEN マイグレーションを実行 THEN 既存データの整合性が保たれる
3. WHEN 新しいスキーマを適用 THEN GoogleOAuthTokenテーブルの構造は変更されない

### 要件3: 認証フローの統合

**ユーザーストーリー:** ユーザーとして、Google認証を一度だけ行ってアカウント作成とサービス連携を完了したいので、手間を減らしたい

#### 受け入れ基準

1. WHEN 新規ユーザーがGoogle OAuth認証を完了 THEN ユーザーアカウントが自動的に作成される
2. WHEN 認証情報が保存される THEN Google Calendar、Gmail等のサービスへのアクセスが可能になる
3. WHEN ユーザーがログインを試行 THEN Google OAuth認証情報の存在でログイン状態を判定する

### 要件4: 既存機能の互換性維持

**ユーザーストーリー:** 開発者として、既存のGoogle OAuth機能（トークン更新、アクセス取り消し等）を維持したいので、システムの安定性を保ちたい

#### 受け入れ基準

1. WHEN トークンが期限切れになる THEN 自動的にリフレッシュトークンを使用して更新される
2. WHEN ユーザーがアクセスを取り消す THEN google_oauth_tokensテーブルからデータが削除される
3. WHEN Google APIを呼び出す THEN 暗号化されたトークンが適切に復号化されて使用される

### 要件5: エラーハンドリングとセキュリティ

**ユーザーストーリー:** 開発者として、認証エラーやセキュリティ問題を適切に処理したいので、システムの信頼性を確保したい

#### 受け入れ基準

1. WHEN OAuth認証が失敗する THEN 適切なエラーメッセージがユーザーに表示される
2. WHEN トークンの暗号化/復号化が失敗する THEN システムは安全にエラーを処理する
3. WHEN 不正なアクセスが検出される THEN システムは適切にアクセスを拒否する