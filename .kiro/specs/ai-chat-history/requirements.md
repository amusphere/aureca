# 要件定義書

## 概要

AIチャット機能に履歴保存機能を追加し、ユーザーが過去の会話を参照できるようにする。現在のAIチャット機能は一回限りの対話となっているが、これを継続的な会話として管理し、コンテキストを保持した対話を可能にする。

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、AIとの会話が自動的に保存されることで、過去の会話を継続し、以前のやり取りを参照できるようにしたい。

#### 受け入れ基準

1. ユーザーがAIにメッセージを送信したとき、システムはユーザーメッセージとAI応答の両方をデータベースに保存する
2. ユーザーがチャットインターフェースにアクセスしたとき、システムは現在のスレッドから会話履歴を表示する
3. ユーザーが新しい会話を開始したとき、システムは新しいチャットスレッドを自動的に作成する
4. ユーザーが既存のチャットスレッドを持たない場合、システムは最初のメッセージ時にスレッドを作成する

### 要件 2

**ユーザーストーリー:** ユーザーとして、チャット履歴をページネーション形式で表示することで、パフォーマンスの問題なく長い会話を効率的に閲覧できるようにしたい。

#### 受け入れ基準

1. チャットメッセージを取得するとき、システムは30件ずつのページでメッセージを返す
2. チャット履歴を表示するとき、システムはメッセージを時系列順（古い順）で表示する
3. ユーザーがより多くのメッセージを要求したとき、システムはページネーションコントロールを提供する
4. チャット履歴を読み込むとき、システムはユーザーメッセージとAI応答の両方を含める

### 要件 3

**ユーザーストーリー:** ユーザーとして、AIが以前の会話のコンテキストを持つことで、より自然で継続的な議論ができるようにしたい。

#### 受け入れ基準

1. AIにメッセージを送信するとき、システムは直近30件のメッセージをコンテキストとして含める
2. AIが応答を生成するとき、会話履歴をコンテキストとして考慮する
3. 会話が長くなりすぎたとき、システムはAIコンテキスト用に最新の30件のメッセージのみを使用する
4. メッセージ履歴を含めるとき、システムはAIプロンプト用に適切にフォーマットする

### 要件 4

**ユーザーストーリー:** ユーザーとして、チャットスレッドを管理することで、会話を整理し、必要に応じて古いものを削除できるようにしたい。

#### 受け入れ基準

1. ユーザーがスレッド削除を要求したとき、システムはスレッドと関連するすべてのメッセージを完全に削除する
2. ユーザーがスレッドにアクセスしたとき、システムは利用可能なチャットスレッドのリストを表示する
3. 新しいスレッドを作成するとき、システムは識別用の一意のUUIDを生成する
4. スレッドが削除されたとき、システムはハードデリートを実行する（チャットデータのソフトデリートは行わない）

### 要件 5

**ユーザーストーリー:** 開発者として、チャットシステムが既存のアーキテクチャパターンに従うことで、現在のコードベースとシームレスに統合できるようにしたい。

#### 受け入れ基準

1. チャットエンドポイントを実装するとき、システムはRouter → Service → Repositoryパターンに従う
2. データベースモデルを作成するとき、システムは標準フィールド（id、uuid、created_at）を持つSQLModelを使用する
3. APIエンドポイントを実装するとき、システムは一貫してasync/awaitパターンを使用する
4. 認証を処理するとき、システムは既存のClerk認証システムと統合する

### 要件 6

**ユーザーストーリー:** システム管理者として、チャットデータが適切に構造化され、パフォーマンスが良いことで、システムが複数のユーザーを効率的に処理できるようにしたい。

#### 受け入れ基準

1. チャットデータを保存するとき、システムはスレッドとメッセージ間の適切なデータベースリレーションシップを使用する
2. チャット履歴をクエリするとき、システムは適切なインデックスを持つ効率的なデータベースクエリを使用する
3. ユーザーがチャットデータにアクセスするとき、システムは認証されたユーザーに属するデータのみを返す
4. タイムスタンプを保存するとき、システムは既存モデルとの一貫性のためUnix float形式を使用する