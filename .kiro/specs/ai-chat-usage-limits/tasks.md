# 実装計画

## Phase 1: 既存システムの削除とコア機能のリファクタリング

- [x] 1. 既存の複雑な設定システムの削除
  - `backend/app/config/ai_chat_limits.json`ファイルを削除
  - `backend/app/config/manager.py`の複雑な設定管理コードを削除
  - 既存のConfigManagerクラスと関連する設定読み込み処理を削除
  - _要件: 1.1, 6.1_

- [x] 2. PlanLimits定数クラスの実装
  - `backend/app/constants/plan_limits.py`ファイルを作成
  - freeプラン（0回）とstandardプラン（10回）の定数を定義
  - プラン名から制限値を取得するメソッドを実装
  - プラン名の有効性チェック機能を実装
  - _要件: 1.1, 1.2, 1.3_

- [x] 3. 軽量データベーススキーマへの移行
  - 既存の`ai_chat_usage_logs`テーブルを`ai_chat_usage`にリネーム
  - 不要なカラムを削除してテーブル構造をシンプル化
  - 最適化されたインデックス`(user_id, usage_date)`を設定
  - Alembicマイグレーションファイルを生成
  - _要件: 3.1, 3.2, 3.3_

- [x] 4. AIChatUsage SQLModelの更新
  - `backend/app/schema.py`の既存モデルを更新
  - テーブル名を`ai_chat_usage`に変更
  - シンプル化されたフィールド構成に更新
  - 適切なリレーションシップとインデックスを設定
  - _要件: 3.1, 3.4_

## Phase 2: Clerk API統合の実装

- [x] 5. ClerkServiceクラスの実装
  - `backend/app/services/clerk_service.py`ファイルを作成
  - Clerk APIクライアントの初期化処理を実装
  - ユーザープラン取得メソッドを実装
  - API エラー時のフォールバック処理（freeプラン）を実装
  - _要件: 2.1, 2.2, 2.3_

- [x] 6. AIChatUsageServiceのリファクタリング
  - 既存のサービスクラスから複雑な設定管理コードを削除
  - PlanLimits定数クラスを使用する制限チェック処理に変更
  - ClerkServiceを統合したプラン取得処理を実装
  - シンプルな利用可否判定メソッド`can_use_chat`を実装
  - _要件: 1.1, 2.1, 4.1, 4.2_

- [x] 7. AIChatUsageRepositoryの最適化
  - 軽量化されたデータベーススキーマに対応
  - 高速な利用数取得クエリを実装
  - 効率的な利用数インクリメント処理を実装
  - 日次リセット処理の最適化
  - _要件: 3.1, 3.2, 3.3, 3.4_

## Phase 3: API層の更新

- [x] 8. バックエンドPydanticモデルの更新
  - 2プラン対応のレスポンスモデルに更新
  - Clerk API エラー用のエラーモデルを追加
  - シンプル化されたフィールド構成に変更
  - 型安全性を確保したモデル定義
  - _要件: 4.1, 4.2_

- [x] 9. APIエンドポイントのリファクタリング
  - 既存の利用回数チェックAPIを軽量化
  - Clerk API統合による動的プラン取得を実装
  - エラーハンドリングの改善（Clerk APIエラー対応）
  - 高速レスポンスのための処理最適化
  - _要件: 2.1, 4.1, 4.2, 4.3_

- [x] 10. 既存AIプロセスAPIの統合更新
  - `/api/ai/process`エンドポイントの利用制限チェックを更新
  - 新しいサービス層インターフェースに対応
  - エラーレスポンスの改善
  - パフォーマンス最適化
  - _要件: 4.1, 4.2, 4.3, 4.4_

## Phase 4: フロントエンドのレスポンシブUI実装

- [ ] 11. TypeScript型定義の更新
  - 2プラン対応の型定義に更新
  - Clerk API エラー用の型を追加
  - レスポンシブUI用のプロパティ型を定義
  - 型安全性を確保した定義
  - _要件: 5.1, 5.2_

- [ ] 12. エラーメッセージ定数の実装
  - `frontend/constants/error_messages.ts`ファイルを作成
  - 2プラン対応の日本語エラーメッセージを定義
  - Clerk API エラー用メッセージを追加
  - ユーザーフレンドリーなメッセージ内容
  - _要件: 5.1, 5.2, 5.3_

- [ ] 13. レスポンシブUsageDisplayコンポーネントの実装
  - `frontend/components/ui/usage_display.tsx`ファイルを作成
  - モバイル・タブレット・デスクトップ対応のレスポンシブデザイン
  - プラン名と利用回数の表示機能
  - Tailwind CSSを使用したスタイリング
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 14. useAIChatUsageフックのリファクタリング
  - 新しいAPI インターフェースに対応
  - Clerk API エラーハンドリングを追加
  - レスポンシブUI用の状態管理を実装
  - パフォーマンス最適化
  - _要件: 5.1, 5.2_

- [ ] 15. AIChatModalコンポーネントの更新
  - レスポンシブUsageDisplayコンポーネントを統合
  - 2プラン対応のUI制御を実装
  - エラー状態の表示改善
  - モバイル対応のタッチインターフェース
  - _要件: 5.1, 5.2, 5.3, 5.4_

## Phase 5: テストとクリーンアップ

- [ ] 16. 既存テストの影響調査と修正計画
  - 削除予定のConfigManagerクラスに依存するテストファイルを全て特定
  - `ai_chat_limits.json`設定ファイルを使用するテストを特定
  - 既存のAIChatUsage関連のフロントエンドテストを調査
  - 修正が必要なテストの一覧を作成し、修正方針を決定
  - _要件: 6.1, 6.2_

- [ ] 17. 既存バックエンドテストの修正と更新
  - `backend/tests/unit/test_config_manager.py`の既存テストを削除または修正
  - 削除されるConfigManagerクラスに依存するテストを特定して修正
  - PlanLimits定数クラスのテストを作成
  - ClerkServiceのテスト（モック使用）を作成
  - リファクタリングされたサービス層のテストを更新
  - リポジトリ層の軽量化テストを実装
  - _要件: 1.1, 2.1, 3.1, 6.1_

- [ ] 18. 既存フロントエンドテストの修正と更新
  - 既存のAIChatUsageに関連するテストファイルを特定
  - 古いAPI インターフェースに依存するテストを修正
  - レスポンシブコンポーネントのテストを作成
  - 更新されたフックのテストを実装
  - エラーハンドリングのテストを更新
  - レスポンシブデザインのテストを追加
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 19. 既存統合テストの修正と新規E2Eテストの実装
  - 既存の統合テストで古いAPI インターフェースを使用している箇所を修正
  - 削除される設定システムに依存するテストを特定して修正
  - Clerk API統合の統合テストを作成
  - 2プラン対応のE2Eテストを実装
  - レスポンシブUIのクロスブラウザテストを実行
  - パフォーマンステストの実装
  - _要件: 2.1, 4.1, 5.1, 6.1_

- [ ] 20. 不要コードの削除とクリーンアップ
  - 旧設定システムの残存コードを削除
  - 使用されていないインポートとファイルを削除
  - コードフォーマットとリンティングを実行
  - ドキュメントの更新
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 21. パフォーマンス検証と最適化
  - ハードコーディング定数アクセスの速度測定
  - データベースクエリ性能の検証
  - Clerk API レスポンス時間の測定
  - 全体的なシステム性能の検証
  - _要件: 1.1, 2.4, 3.4, 4.4_